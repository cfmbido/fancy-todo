<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>

    <div>
        INI WEBSITE BENERAN LOH
        <button id="logout">LOGOUT</button>
    </div>

    <div>
        <h1>FANCY TODO</h1>
    </div>

    <div id="login-form">
        <form action="" id="login">
            <div>
                <label for="">Email</label>
                <input type="text" id="login-email">
            </div>
            <div>
                <label for="">Password</label>
                <input type="text" id="login-password">
            </div>
            <div>
                <input type="submit" value="Login">
            </div>
        </form>
    </div>
    
    <div id="add-todo-form">
        <form action="" id="add-todo">
            <div>
                <label for="">Title</label>
                <input type="text" id="add-todo-title">
            </div>
            <div>
                <label for="">Description</label>
                <input type="text" id="add-todo-description">
            </div>
            <div>
                <label for="">Status</label>
                <input type="text" id="add-todo-status">
            </div>
            <div>
                <label for="">Due Date</label>
                <input type="date" id="add-todo-duedate">
            </div>
            <div>
                <input type="submit" value="Submit">
            </div>
        </form>
    </div>

    <div id="content-form">
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>

        function showloginpage(){
            $("#login-form").show()
            $("#add-todo-form").hide()
            $("#content-form").hide()
            $("#logout").hide()
        }

        function showcontentpage(){
            $("#login-form").hide()
            $("#add-todo-form").show()
            $("#content-form").show()
            $("#logout").show()
        }

        function getTodo(){
            $.ajax({
                type: "GET",
                url: 'http://localhost:3000/todos',
                headers: {
                    access_token : localStorage.getItem('access_token')
                }
            })
            .done(data => {
                showcontentpage()
                $("#content-form").empty()
                $("#content-form").append(`
        <table>
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Due Date</th>
                </tr>
            </thead>
            <tbody id="all-todos">
            </tbody>
        </table>`)
                data.forEach(element => {
                    $("#all-todos").append(` <tr>
                        <td>${element.title}</td>
                        <td>${element.description}</td>
                        <td>${element.status}</td>
                        <td>${element.due_date}</td>
                        <td><button onclick="${element.id}">Edit</button> | <button onclick="deletetodo(${element.id})">Delete</button></td>
                    </tr>`)
                });
            })
            .fail((xhr, text) => {
                console.log(xhr, text)
            })
        }

        function login(){
            const email = $("#login-email").val()
            const password = $("#login-password").val()
            $.ajax({
                type: "POST",
                url: 'http://localhost:3000/login',
                data: {
                    email: email,
                    password: password
                }})
                .done(data => {
                    localStorage.setItem('access_token', data.access_token)
                    getTodo()
                    console.log(data)
                })
                .fail((xhr, text) => {
                    console.log(xhr, text)
                })
                .always(() => {
                    $("#login").trigger("reset")
                })        
        }

        function addtodo(){
            const title = $("#add-todo-title").val()
            const description = $("#add-todo-description").val()
            const status = $("#add-todo-status").val()
            const due_date = $("#add-todo-duedate").val()
            console.log(title, description, status, due_date)
            $.ajax({
                type: "POST",
                url: 'http://localhost:3000/todos',
                headers: {
                    access_token : localStorage.getItem('access_token')
                },
                data: {
                    title: title,
                    description: description,
                    status: status,
                    due_date: due_date
                }})
                .done(data => {
                    getTodo()
                })
                .fail((xhr, text) => {
                    console.log(xhr, text)
                })
                .always(() => {
                    $("#add-todo").trigger("reset")
                })
        }

        function deletetodo(id){
            $.ajax({
                type: "DELETE",
                url: 'http://localhost:3000/todos/'+id,
                headers: {
                    access_token : localStorage.getItem('access_token')
                }
            })
            .done(data => {
                console.log(data)
                getTodo()
            })
            .fail((xhr, text) => {
                console.log(xhr, text)
            })
        }

        $(document).ready(function(){

            if(localStorage.getItem('access_token')){
                showcontentpage()
                getTodo()
            }else{
                showloginpage()
            }
            $("#login").on("submit", (e) => {
                e.preventDefault()
                login()
            })
            $("#add-todo").on("submit", (e) => {
                e.preventDefault()
                addtodo()
            })
            $("#logout").on("click", (e) => {
                localStorage.clear()
                showloginpage()
            })
        });
    </script>
</body>
</html>
